## MEMO -システム仕様書-
### By ご飯システム班の一人
システムの仕様を記しておきます。どのようなつもりでプログラムを書いたかは、
手続き型の言語だと眺めただけではわかりにくいし、コメントを書いても理解しにくい
というのが個人的な意見です。私が一人で作ってしまった部分は特に後からわからなく
なったら困るので、一応仕様書として残しておきます。

仮に明らかに仕様が間違っている・または仕様に対して
明らかに間違った実装がなされている場合には教えてください
### 注意
このファイルはマークダウン言語で書かれています。txtファイルとしても読めると
思いますが、マークダウンならちょっと読みやすいです。
ブラウザ上で使えるマークダウンビューアとかを使うといいと思います。
github上なら自動で綺麗に表示されるはずです。


## tl;dr　長文読みたくない人向け三行
+ strategyの中をいじろう
+ タスクはどうにか動くように作ってます
+ MoveLengthつかえば動くよ

# 基本機能
+ ヘッダー・フッターの常時描画
  + デバッグ情報・残り時間の表示
+ メニュー画面
  + メニュー画面でキャンセルを押すと電源が切れます。
  + メニュー画面から起動した関数の実行中キャンセルを押すとメニューにもどります。
+ Move系API
  + パワー・回転比・移動距離を指定するだけでPID制御しつつ移動します。
+ ログ機能
  + 画面にログを残します(潜在的なエラーがあるかも?)

## 戦略用関数 strategy
メニュー画面でStartを選択すると、`strategy`という関数が起動します。
この関数内で実際のものあつめ処理を行います。

## 移動関数 Move~
このシステムは基本的に`g_power`と`g_turn`の2つを指定することで機能します。

`g_power`はモータに与えるパワー、`g_turn`は
+ 絶対値は 「外側のタイヤに対し内側のタイヤは(100-turn%)回る」
+ 符号は「正なら左が外側、負なら右が外側」

を表します。Moveから始まるいくつかの関数でこれらを設定、
モータの値を初期化しています。

一旦これらの値を設定した後、MoveTskというタスクを起動すると、モータに与えるパワーが
自動で制御されます。タスク起動と終了を行うラッパー関数を用意しました。

MoveTskは`#define MOVETSK_WAIT`に定義された分だけdly_tskで待ち、その間に
回転したモータの角度を測定します。
この場合のPID制御の対象は「タイヤの回転角度の比」です。私達は狙ったところにロボットが
着きさえすればよく、そのために必要なのは左右の回転角度の比だけであり、
正確な回転速度にはこだわる必要はないので、角度の比のみの制御を行います。

MoveTskは取得した外側のモータの回転角度に対する、内側のモータの回転角度の
比をとります。この比を`g_turn`の絶対値と比べ、PID制御します。

## アーム系関数
カリブレーション時アームの最下点と最高点を確認します。
最下点においてモータの回転角度は0にセットし、その後最高点の角度を記録します。

関数`MoveArm`でアームを上下させます。最下点から何度上に上げるかを引数に指定します。
現状、マイナス方向に回転することでアームが上に上がるようなので、その
分を考慮に入れないといけません。

また、タスク化していないのでこの関数を呼ぶとそこで処理がストップします。
すなわち、`MoveArm`を呼んでからイベントフラグを待つ、といったことは
出来ません。仮にそれが必要になるようならタスク化を考えます。

## ディスプレイ・ログ系関数
DispTskというタスクが常にヘッダーとフッターを描画し続けます。
ディスプレイは共有資源で、下手に並列で変更するとエラーを起こしかねないと
判断し、セマフォで占有権を制御することにしました。

この場合、ログを表示するだけでも
セマフォ待ち＞出力＞セマフォ返却　という処理が多く行われるので、
この一連の処理を行うラッパー関数を作りました。

注意点として、それらの関数を優先度の高いタスクから呼ぶ際、
優先度逆転が起こる可能性があるということを知っておいてください。
現状なにも手を打つつもりはありませんが、問題になるようなら対処します。

## タスク関係
後日追記するかも?

## その他
+ 余計なことをするようですが、ファイル名はサンプルと変え`monoatume`に統一してます。
ローカルにサンプルプログラムのコピーがあり、それと混同することが非常に多かったからです。

## もし私に何かあったときのために　後任の方へ
+ 仮に急に加速する・まっすぐ進まない等あれば、恐らくMoveTsk内の処理が原因です。



### 参考文献(ほとんど眺めただけ)：
##### 宇津木諭　絵ときでわかる機械制御 2006 オーム社
ほとんどラプラス空間で話をするし細かい実装とかは書いてないしであんまり
使えないなぁと思った
##### 志水清孝　フィードバック制御理論-安定化と最適化- 2013 コロナ社
じゃあ難しそうな本ならどうかと思ったら何書いてあるかさっぱりで
一時間ほど寝ました

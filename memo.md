## MEMO -μTRONの仕様とシステムの方針について-
### By ご飯システム班の一人
***
11/16
最初から細かくプログラムとμTRONの仕様を読んでおくことにした。
こういうことは得意だ。以下に気になった仕様と何故書いてあるのかわからないもの
を理解するためのメモを記しておく。
### 注意
このファイルは**マークダウン言語**で書かれています。txtファイルとしても読めると
思いますが、マークダウンならちょっと読みやすいです。
ブラウザ上で使えるマークダウンビューアとかを使うといいと思います。

***
### #define \_MACRO\_ONLYって何？
.cfgファイルの先頭に書かれている#define \_MACRO\_ONLYの役割は
それ以降のファイルが`#include`された際にマクロ以外のC言語的な宣言があると
エラーをおこしてしまうため、ヘッダーガードとして使われているようだ
(μTRON-4.02仕様書p37)。文字通りマクロのみを読み込む、ということか。

### コンパイルするときには\_MACRO\_ONLYは定義されてる？
実際のコンパイル(make)時に.cfgファイルはMakefile内に指定されてあるように
変数にパスが渡されている。実際のコンパイル時には\_MACRO\_ONLYは`#define`
されていないことになっているはずである。
##### ＞ちなみに
Makefileは設定を行った後Ecrobotとかいうディレクトリ内にあるecrobot.mak
というファイルを読み込んでいる。おそらく実際のコンパイルはそちらで行われている
のだろう。「はず」だの「だろう」だのが多いのは実際の処理がわからないからである。

### INCLUDEってなに？`#include`とは何が違うの？
.cfgファイルの`INCLUDE`は静的APIの1つで、ほとんどC言語の`#include`と同じである。
しかし、コンフィギュレータ*は`INCLUDE`しか理解できず、`#include`は
Cプリプロセッサが使用するものである。

面白いことに、.cfgファイルは一度Cプリプロセッサに通されるらしい
(μTRON-4.02仕様書p34)。Cプリプロセッサとは本来C言語を整形するための
プログラムで、`#define`とか`#include`はプリプロセッサが処理するという話は
どこかで聞いたことがあるのではないか。

CプリプロセッサはC言語以外にも
利用可能(文法とかが似ていることが前提らしいが)で、μTRONでは整形した.cfgファイル
を生成するために使うよう指定しているようだ。

***コンフィギュレータ**：最終的にkernel_cfg.cなどのファイルを
出力するやつだと思う

##### ＞要するに
+ `#include`はCプリプロセッサが理解するもの
+ `INCLUDE`はそれ以外が理解するもの

### 個人的な疑問1
.cfgファイルにおいてCRE_TSKという静的APIを用いることで、タスクを生成することが
できる。これは誰が見てもすぐわかるが、ここで1つ疑問が生じた。
.cfgファイルはCのファイルを読んでいないのだ。にもかかわらず、タスク指定時
Cの関数名を指定している。これは果たしてどのように行われているのか。

これはそのまま、コンフィギュレータが生成するkernel_cfg.cにおいて名前が
コピーされて、関数ポインタから呼び出されているだけのようだ。
##### ＞要するに
そこを考える必要なし！

### 個人的な疑問2
タスクにタスクIDとして静的APIに渡されている値がTinitとかよくわからん
値だが、これはどこで定義されているのか。

「定義されるのではなくここで定義している」が答えだろう。
IDが数値であるという思い込みからきた勘違いだ。

### サービスコールって何？
仕様書曰く、
>アプリケーションプログラムからカーネル
>またはソフトウェア部品を呼び出すインターフェース

のことらしい。要するにAPIのことだね。`act_tsk`とかがそうです。

### タスク用の関数にある引数ってなに？
タスク用として存在している関数にはみんな`VP_INT exinf`という引数がある。
タスク用関数に与えられる引数は仕様書では拡張情報と呼ばれている。
基本は静的APIにおいて定義された拡張情報が渡されるようだが、
サービスコールである`sta_tsk`から呼び出す際には
この引数に直接値を渡すことができるようだ。

あとは`VP_INT`だが、これは仕様書に以下の定義があった。
「データタイプが定まらないものへのポインタまたはプロセッサに自然な
　サイズの符号付き整数」
要するに普通の`int`だろう。`int`も実際ポインタとして使用することが可能だし。
ちなみに前回のプログラムではタスク起動に`act_tsk`を使用していた。
これは引数に値を渡すこと無くタスクを起動するサービスコールのことである。

### 割り込みハンドラって何？どんなときに使うんだ？
その名の通り、割り込みのハンドラらしい。外部からOSの処理にたいして割り込み
を行うことがあるが、その際に何をするかを決めるもののようだ。

教科書には、割り込みハンドラを定義する静的API `DEF_INH`を使用する場合、
事前に`at91sam7s.h`というファイルを`#include`かつ`INCLUDE`しなければ
ならない、といったことが書かれてあった。これに関しては
割り込み処理は基本的にはCPU依存だから、細かな実装は処理系ごとに
異なると仕様書にわざわざ書いてあった。おそらくこのファイルに`DEF_INH`とかに
使用する定義か何かが書いてあるのだろう。
だから変なものをINCLUDEしないといけないわけだ。

ライントレース用プログラムではjsp_systick_low_priorityが設定されている。


### 周期ハンドラってなに？
教科書にも仕様書にも、
>一定周期で起動されるタイムイベントハンドラである

と一言一句違わず書いてあるが、果たしてそれが何を意味しているのかわからない。
タイムイベントハンドラというのは、時間に関係するハンドラの総称であるといった
ようなことが一応仕様書には書いてある(p240)。
果たしてそれが何を意味しているのか。

前回のライントレース用プログラムにおける実装をみるに、ただ単純に周期的
に起動したい関数を指定するだけで良いようだ。

### 今更だけどハンドラとタスクは何が違うんだ？
疲れた

#### 参考文献(ほとんど眺めただけ)：
###### 宇津木諭　絵ときでわかる機械制御 2006 オーム社
ほとんどラプラス空間で話をするし細かい実装とかは書いてないしであんまり
使えないなぁと思った
###### 志水清孝　フィードバック制御理論-安定化と最適化- 2013 コロナ社
じゃあ難しそうな本ならどうかと思ったら何書いてあるかさっぱりで
一時間ほど寝ました
###### μTRON ver4.2.0仕様書
これが一番使えた
###### 教科書
実験の教科書のAPI部分は仕様書のコピペ
でもマルチタスク云々はわかりやすいと思う　たぶんね
###### https://www.tron.org/ja/onwebseminar/chap3/
多分tron公式のサイト なんか書いてある
